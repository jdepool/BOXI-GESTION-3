# Overview

BoxiSleep is a comprehensive sales management system designed for a sleep products company. It streamlines operations from data ingestion to analytics, supporting multiple product lines (Boxi and Mompox) and their respective sales channels (Shopify, ShopMom). Key capabilities include sales data upload, advanced record management with filtering and export, financial payment tracking, and real-time analytics on sales performance, delivery status, and channel-specific metrics to empower informed business decisions.

# User Preferences

Preferred communication style: Simple, everyday language.
Cargar Datos Implementation: Implemented as a settings/gear icon button positioned in the top-right of the tabs bar, opening a dialog with upload controls and automation settings. This separates administrative features from regular sales workflow tabs.
Address Form Organization: All address forms (Direcciones, Manual Sales, Manual Reserva) display Dirección de Despacho first, followed by a checkbox (checked by default) labeled "La dirección de facturación es igual a la de despacho". Dirección de Facturación fields appear below only when the checkbox is unchecked. When checked, shipping address changes automatically sync to billing address. Despacho fields are required; facturación fields are optional when addresses differ.
Reportes Organization: Reportes tab displays a dashboard with card-based layout where each report type is accessible via a dedicated button. Currently includes "Reporte temporal de Ordenes", "Ordenes Perdidas", and "Prospectos Perdidos" cards. This scalable structure allows easy addition of new report types as separate cards.
Status Badge Color System: Standardized color-coded badges across Ingresos and Egresos verification systems using shared utility functions in `client/src/lib/badge-utils.ts`. Consistent colors: Verificado (green), Por verificar/Pagado (amber), Rechazado (purple). Egresos-specific: Por Pagar (red), Por Autorizar (blue), Borrador (grey). All colors include dark mode variants. The "Pagado a" field (formerly "Beneficiario") identifies payee in egresos workflow.
Egresos Verification Table: Simplified interface in Verificación section displays only verification-essential columns: Fecha de pago, Monto Pagado Bs, Monto Pagado USD, Referencia, Banco, Estado (with colored badge), Notas. Verification dialog similarly streamlined to show only payment-relevant details. This focused design eliminates administrative fields (Tipo, Descripción, Pagado a) from the verification workflow.
Excel Export Filtering: All Excel export buttons in Ventas Mompox (Lista de Ventas, Inmediatas, Reservas, Pagos) use `canalMompox: 'true'` filter to ensure exports match displayed data. The PagosTable component accepts `extraExportParams` prop for dynamic filtering. Export filtering follows the "what you see is what you export" principle - exported data always matches the filtered table view.

# System Architecture

## UI/UX Design
The application utilizes a React 18 and TypeScript frontend, Wouter for routing, and shadcn/ui components (based on Radix UI) styled with Tailwind CSS for an accessible user interface. A tabbed structure organizes sales management and payment verification, with administrative functions accessible via a settings icon. A `DateRangePicker` handles date filtering. The system supports two distinct sales workflow pages ("Ventas" for Boxi products and "Ventas Mompox" for Mompox products), each with identical tab structures but filtered by their respective channel groups. Manual sales forms pre-fill the `canal` field based on the product line.

## Technical Implementations
The backend is an Express.js and TypeScript RESTful API, using PostgreSQL with Drizzle ORM. Authentication is handled by basic username/password with PostgreSQL session storage. Date-only fields are stored as `YYYY-MM-DD` strings to prevent timezone issues. Canal values are normalized during upload for consistency. The order search system employs dual modes (`search`, `ordenExacto`, `orden`) to prevent historical order confusion, especially in payment modals. A dual email system sends order confirmations using GoDaddy SMTP for Mompox sales and Microsoft Outlook via Graph API for Boxi sales, with logic in `server/services/email-service.ts`. **Estados de Entrega**: The system uses 10 standardized delivery statuses defined in `shared/schema.ts`: Pendiente, Perdida, En proceso, A despachar, En tránsito, Entregado, A devolver, Devuelto, A cancelar, and Cancelada. All UI filters are aligned with these schema-defined statuses.

## Feature Specifications
- **Sales Data Management**: Supports Excel uploads with replacement logic, filtering, searching, and export. Includes webhook integrations for automated order ingestion from Shopify (Boxi), ShopMom (Mompox), and address updates from Treble-Boxi. **Automatic SKU Enrichment**: The system automatically enriches missing SKU values by performing exact-match lookups against the `productos` table during all data ingestion points (Excel uploads, webhooks, manual sales creation, and order updates). This ensures SKU data persists in the database for direct SQL reporting capabilities. Implementation uses the `enrichSkuFromProduct()` helper function in `server/storage.ts` with O(1) performance via Map-based lookup. **SKU Correction Tool**: Administrative tab "Corregir SKUs" in Administración section provides a UI to search and update ANY SKU value (not just NULL) for any order. Supports searching by order number and editing SKU values directly. **Cashea Excel Upload Pricing**: Manual Cashea/Cashea MP Excel uploads use identical pricing logic to automatic downloads: (1) "Total (USD)" column from Excel → `totalOrderUsd` field; (2) Product name → SKU lookup via `productos` table; (3) SKU → `precioCasheaUsd` lookup via `precios` table; (4) Calculate `totalUsd = precioCasheaUsd × cantidad`; (5) Fallback to "Total (USD)" value if pricing not found. This ensures complete pricing parity between manual uploads and automated downloads. Implementation in `server/routes.ts` `/api/upload` endpoint with detailed logging for product mapping, pricing lookups, and fallback behavior. **Treble-Boxi Address Webhook**: The `/api/webhooks/treble-boxi` endpoint accepts address updates in key/value pair format (key, value, key_1, value_1, etc.) and automatically updates existing orders. Maps incoming fields (numero_orden, estado, ciudad, urbanizacion, direccion_unificada, indicaciones, misma_dir_fact, direccion_facturacion) to database address fields. Handles both unified and separate billing addresses based on the misma_dir_fact flag.
- **Order & Payment Tracking**: Comprehensive tracking of sales, delivery statuses, multi-product orders, and reservations. Features payment verification, multi-currency support, and `Pendiente` (balance) calculation. **Automated Payment Verification via Bank Statement Reconciliation**: The Conciliación tab enables automatic payment verification by uploading bank statements (Excel/CSV). The system matches bank transactions with pending VES payments using strict criteria: (1) **100% confidence** requires exact reference match (identical after cleaning OR complete containment with 6+ digits minimum) + exact amount match; (2) **90% confidence** when exact reference (identical/containment) + amount within Bs 1000 tolerance OR exact amount + only 1 digit differs in reference; (3) All other cases are rejected. Matches with ≥90% confidence are verified automatically. Reference matching supports two types of exact matches: (a) Identical match after removing non-numeric characters and leading zeros (e.g., "0000012345678" = "12345678"), (b) Complete containment where one reference contains the other completely with minimum 6 digits (e.g., "789012345678999" contains "12345678"). Implementation in `client/src/components/admin/verificacion-pagos-cashea-tab.tsx`.
- **Delivery Workflow**: Manages channel-specific delivery status progression, returns, and cancellations. Simplified filtering is applied across various sales tables. **Devoluciones & Cancelaciones Workflows**: Parallel workflows with identical structure: auto-generated start dates (`fechaDevolucion`/`fechaCancelacion`) preserve manual edits on subsequent actions; editable finalization dates (`finalizacionDevolucion`/`finalizacionCancelacion`) serve as completion gates; completion buttons ("Devuelto"/"Cancelado") require finalization dates to be filled. Both workflows maintain full paridity in logic and UX.
- **Lead Management (Prospectos)**: Tracks leads with a 3-phase CRM follow-up workflow, automated date calculations, visual status tracking, and daily email reminders.
- **Follow-Up Protocols (Protocolos de Seguimiento)**: Configurable 3-phase follow-up protocols for both `Prospectos` and `Ordenes Pendientes`, allowing independent configuration of intervals and email recipients.
- **Pricing & Cost Management**: Tracks product prices and unit costs in USD with effective dates, supporting multiple records per SKU, Excel uploads, and undo functionality. **IVA Field**: Each price record can optionally include an IVA (%) value stored as a decimal field, displayed in the table, editable in forms, and supported in Excel uploads (optional column).
- **Product Classification System**: A flat tag-based system using a single `categorias` table for Marca, Categoría, Subcategoría, and Característica, with no enforced hierarchy. Products link via foreign keys. Admin UI and Excel uploads support this structure. **Product Components System**: A relational component tracking system using `productos_componentes` table to manage product composition. Each SKU has one or more component SKUs with quantities - combo products (categoría contains "Combo") consist of multiple component SKUs, while simple products self-reference (SKU points to itself with quantity 1). This enables: (1) inventory management by tracking individual components; (2) cost calculation by summing component costs; (3) despacho verification ensuring all combo pieces are shipped; (4) comprehensive reporting on component-level sales. Implementation uses foreign key relationships with indexes on `sku_producto` and `sku_componente` for efficient queries. All products have at least one component record - combos expand into constituent parts, non-combos self-reference for uniformity.
- **Estados and Ciudades Master Data**: Hierarchical address management system for Venezuela, with 24 estados and 48 cities. Implemented via `estados` and `ciudades` tables, using smart filtering in address forms.
- **Automation**: Configurable automated Cashea order downloads and payment detail assignment. **Dual Cashea Portal Support**: The automation system automatically downloads from both Cashea portals - "Cashea" (Boxi Sleep using marketplace@boxisleep.com) and "Cashea MP" (Mompox using marketplace@mompox.com) - during each scheduled execution. The system uses the appropriate credentials for each portal and records download history separately. Both portals are queried every 30 minutes (or configured interval), ensuring all orders from both Boxi and Mompox product lines are captured automatically.
- **Reporting**: A dashboard-based system provides access to various reports, including temporary orders, lost orders, and lost prospects, all with date filtering and Excel export.
- **Order Numbering**: Separate order number ranges for manual (20000+) and Tienda (30000+) orders.
- **Accounts Payable (Egresos)**: A 4-stage workflow system (registration, authorization, payment recording, verification) for managing expenses. Features smart form submission, a correlative number system for each egreso, and clear workflow stages (Borrador → Por Autorizar/Por Pagar → Por verificar → Verificado/Rechazado).

# External Dependencies

## Database Services
- **Neon Database**: Serverless PostgreSQL hosting.
- **Drizzle ORM**: Type-safe database client.

## File Processing
- **SheetJS (XLSX)**: Excel file parsing.
- **Multer**: Express middleware for file uploads.
- **CSV Parse**: CSV file parsing.

## UI and Styling
- **shadcn/ui**: Pre-built component library.
- **Radix UI**: Unstyled, accessible UI primitives.
- **Tailwind CSS**: Utility-first CSS framework.
- **Lucide React**: Icon library.

## Data Management
- **TanStack Query**: Server state management and caching.
- **date-fns**: Date manipulation.
- **Zod**: Schema validation.